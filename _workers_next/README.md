# LDC Shop (Cloudflare Workers Edition)


åŸºäº **Next.js 16**ã€**Cloudflare Workers** (OpenNext)ã€**D1 Database** å’Œ **Shadcn UI** æ„å»ºçš„æ— æœåŠ¡å™¨è™šæ‹Ÿå•†å“å•†åº—ã€‚

## ğŸ›  æŠ€æœ¯æ¶æ„ (Technical Architecture)

æœ¬ç‰ˆæœ¬é‡‡ç”¨ **Next.js on Workers** çš„å‰æ²¿æŠ€æœ¯è·¯çº¿ï¼Œè€Œéä¼ ç»Ÿçš„å•æ–‡ä»¶ Workerï¼š

*   **æ ¸å¿ƒæ¡†æ¶**: **Next.js 16 (App Router)** - ä¿æŒä¸ Vercel ç‰ˆæœ¬ä¸€è‡´çš„ç°ä»£åŒ–å¼€å‘ä½“éªŒã€‚
*   **é€‚é…å™¨**: **OpenNext (Cloudflare Adapter)** - ç›®å‰æœ€å…ˆè¿›çš„ Next.js åˆ° Workers çš„è½¬æ¢æ–¹æ¡ˆï¼Œæ”¯æŒå¤§éƒ¨åˆ† Next.js ç‰¹æ€§ã€‚
*   **æ•°æ®åº“**: **Cloudflare D1 (SQLite)** - è¾¹ç¼˜åŸç”Ÿå…³ç³»å‹æ•°æ®åº“ï¼Œæ›¿ä»£ Vercel Postgresã€‚
*   **ORM**: **Drizzle ORM** - å®Œç¾é€‚é… D1ï¼Œæä¾›ç±»å‹å®‰å…¨çš„ SQL æ“ä½œã€‚
*   **éƒ¨ç½²**: **Wrangler** - ä¸€é”®éƒ¨ç½²åˆ°å…¨çƒè¾¹ç¼˜ç½‘ç»œã€‚

æ­¤æ¶æ„æ—¨åœ¨ç»“åˆ Next.js çš„å¼€å‘æ•ˆç‡ä¸ Cloudflare çš„è¾¹ç¼˜æ€§èƒ½/ä½æˆæœ¬ä¼˜åŠ¿ã€‚

## âœ¨ ç‰¹æ€§

- **ç°ä»£æŠ€æœ¯æ ˆ**: Next.js 16 (App Router), Tailwind CSS, TypeScriptã€‚
- **è¾¹ç¼˜åŸç”Ÿ**: Cloudflare Workers + D1 æ•°æ®åº“ï¼Œä½æˆæœ¬é«˜æ€§èƒ½ã€‚
- **Linux DO é›†æˆ**: å†…ç½® OIDC ç™»å½•ä¸ EasyPay æ”¯ä»˜ã€‚
- **å•†åŸä½“éªŒ**:
    - ğŸ” **æœç´¢ä¸åˆ†ç±»ç­›é€‰**: å®¢æˆ·ç«¯å³æ—¶æœç´¢ä¸åˆ†ç±»è¿‡æ»¤ã€‚
    - ğŸ’¡ **å¿ƒæ„¿å•ä¸æŠ•ç¥¨**: ç”¨æˆ·å¯æäº¤æƒ³è¦çš„å•†å“å¹¶æŠ•ç¥¨ï¼ˆåå°å¯å¼€å¯/å…³é—­ï¼‰ã€‚
    - ğŸ“¢ **å…¬å‘Šæ **: é¦–é¡µå…¬å‘Šé…ç½®ä¸å±•ç¤ºã€‚
    - ğŸ“ **Markdown æè¿°**: å•†å“æ”¯æŒå¯Œæ–‡æœ¬å±•ç¤ºã€‚
    - âš ï¸ **è´­ä¹°å‰æé†’**: æ”¯æŒè´­ä¹°å‰å¼¹çª—æç¤ºã€‚
    - ğŸ”¥ **çƒ­é—¨ä¸æŠ˜æ‰£**: æ”¯æŒçƒ­é—¨æ ‡è®°ä¸åŸä»·/æŠ˜æ‰£ä»·å±•ç¤ºã€‚
    - â­ **è¯„åˆ†ä¸è¯„è®º**: å·²è´­ç”¨æˆ·å¯è¯„åˆ†/è¯„è®ºï¼Œåˆ—è¡¨å±•ç¤ºè¯„åˆ†ã€‚
    - ğŸ“¦ **åº“å­˜/å·²å”®æ˜¾ç¤º**: å®æ—¶å±•ç¤ºå¯ç”¨åº“å­˜ä¸å·²å”®æ•°é‡ã€‚
    - â™¾ï¸ **å…±äº«å¡å¯†å•†å“**: æ”¯æŒæ— é™åº“å­˜å•†å“ï¼ˆå…±äº«è´¦å·/æ•™ç¨‹ç­‰ï¼‰ã€‚
    - ğŸš« **é™è´­**: æŒ‰å·²æ”¯ä»˜æ¬¡æ•°é™åˆ¶è´­ä¹°ã€‚
    - ğŸ”¢ **æ•°é‡é€‰æ‹©**: æ”¯æŒè´­ä¹°å¤šä¸ªå•†å“ï¼ˆå—é™äºåº“å­˜ä¸é™è´­æ•°é‡ï¼‰ã€‚
    - ğŸ·ï¸ **è‡ªå®šä¹‰å•†åº—åç§°**: æ”¯æŒè‡ªå®šä¹‰æ˜¾ç¤ºåœ¨æ ‡é¢˜å’Œå¯¼èˆªæ çš„å•†åº—åç§°ã€‚
- **è®¢å•ä¸å‘è´§**:
    - âœ… **æ”¯ä»˜å›è°ƒéªŒç­¾**: ç­¾åä¸é‡‘é¢æ ¡éªŒã€‚
    - ğŸ **è‡ªåŠ¨å‘è´§å¡å¯†**: æ”¯ä»˜æˆåŠŸåè‡ªåŠ¨å‘æ”¾å¡å¯†ï¼Œç¼ºè´§åˆ™æ ‡è®°å·²æ”¯ä»˜å¾…å¤„ç†ã€‚
    - ğŸ“¦ **å¤šå¡å¯†åˆ†å‘**: è´­ä¹°å¤šä»¶å•†å“æ—¶ï¼Œè®¢å•è¯¦æƒ…é¡µè‡ªåŠ¨åˆ†è¡Œå±•ç¤ºå¤šä¸ªå¡å¯†ã€‚
    - ğŸ“§ **é»˜è®¤æ”¶ä»¶é‚®ç®±**: ä¸ªäººä¸­å¿ƒå¯è®¾ç½®é»˜è®¤é‚®ç®±ï¼Œå‘è´§é‚®ä»¶ä¼˜å…ˆå‘é€åˆ°è¯¥é‚®ç®±ã€‚
    - ğŸ”’ **åº“å­˜é”å®š**: è¿›å…¥æ”¯ä»˜é¡µåé”å®š 5 åˆ†é’Ÿï¼Œé˜²æ­¢å¹¶å‘è¶…å–ã€‚
    - â±ï¸ **è¶…æ—¶å–æ¶ˆ**: 5 åˆ†é’Ÿæœªæ”¯ä»˜è‡ªåŠ¨å–æ¶ˆè®¢å•å¹¶é‡Šæ”¾åº“å­˜ã€‚
    - ğŸ§¾ **è®¢å•ä¸­å¿ƒ**: è®¢å•åˆ—è¡¨ä¸è¯¦æƒ…é¡µã€‚
    - ğŸ”” **å¾…æ”¯ä»˜æé†’**: é¦–é¡µæ¨ªå¹…æé†’æœªæ”¯ä»˜è®¢å•ï¼Œé˜²æ­¢æ¼å•ã€‚
    - ğŸ”„ **é€€æ¬¾ç”³è¯·**: ç”¨æˆ·å¯æäº¤é€€æ¬¾ç”³è¯·ï¼Œç®¡ç†å‘˜å®¡æ ¸ä¸å¤„ç†ã€‚
    - âœ… **è‡ªåŠ¨é€€æ¬¾**: ç®¡ç†å‘˜åŒæ„é€€æ¬¾åè‡ªåŠ¨è§¦å‘é€€æ¬¾ï¼ˆæ”¯æŒå¤±è´¥æç¤ºï¼‰ã€‚
    - ğŸ’³ **æ”¶æ¬¾ç **: ç®¡ç†å‘˜å¯ç”Ÿæˆæ”¶æ¬¾é“¾æ¥/äºŒç»´ç ï¼Œæ— éœ€å•†å“å³å¯ç›´æ¥æ”¶æ¬¾ã€‚
- **ç®¡ç†åå°**:
    - ğŸ“Š **é”€å”®ç»Ÿè®¡**: ä»Šæ—¥/æœ¬å‘¨/æœ¬æœˆ/æ€»è®¡ã€‚
    - âš ï¸ **åº“å­˜é¢„è­¦**: ä½åº“å­˜é˜ˆå€¼é…ç½®ä¸é¢„è­¦æç¤ºã€‚
    - ğŸ§© **å•†å“ç®¡ç†**: æ–°å»º/ç¼–è¾‘/ä¸Šä¸‹æ¶/æ’åº/é™è´­ã€‚
    - ğŸ·ï¸ **åˆ†ç±»ç®¡ç†**: åˆ†ç±»å¢åˆ æ”¹ã€å›¾æ ‡è®¾ç½®ã€æ’åºã€‚
    - ğŸ—‚ï¸ **å¡å¯†ç®¡ç†**: æ‰¹é‡å¯¼å…¥ã€æ‰¹é‡åˆ é™¤æœªä½¿ç”¨å¡å¯†ã€‚
    - ğŸ’³ **è®¢å•ç®¡ç†**: åˆ†é¡µ/æœç´¢/ç­›é€‰ã€è®¢å•è¯¦æƒ…ã€æ ‡è®°å·²æ”¯ä»˜/å·²å‘è´§/å–æ¶ˆã€‚
    - ğŸ§¹ **è®¢å•æ¸…ç†**: æ”¯æŒæ‰¹é‡é€‰æ‹©ä¸æ‰¹é‡åˆ é™¤ã€‚
    - â­ **è¯„ä»·ç®¡ç†**: æœç´¢ä¸åˆ é™¤è¯„ä»·ã€‚
    - ğŸ“¦ **æ•°æ®ç®¡ç†**: å…¨é‡å¯¼å‡º SQLï¼ˆå…¼å®¹ D1ï¼‰ï¼Œæ”¯æŒä» Vercel ç‰ˆ SQL å¯¼å…¥ã€‚
    - ğŸ“£ **å…¬å‘Šç®¡ç†**: é¦–é¡µå…¬å‘Šé…ç½®ã€‚
    - ğŸ‘¥ **é¡¾å®¢ç®¡ç†**: æŸ¥çœ‹é¡¾å®¢åˆ—è¡¨ã€ç§¯åˆ†ç®¡ç†ã€æ‹‰é»‘/è§£å°ã€‚
    - ğŸ“¨ **æ¶ˆæ¯ç®¡ç†**: ç®¡ç†å‘˜å¯å‘å…¨éƒ¨/æŒ‡å®šç”¨æˆ·å‘é€ç«™å†…æ¶ˆæ¯ï¼Œæ”¯æŒæŸ¥çœ‹ç”¨æˆ·æ¥ä¿¡ä¸å‘é€å†å²ã€‚
    - âš™ï¸ **é€€æ¬¾è®¾ç½®**: å¯é…ç½®é€€æ¬¾åå¡å¯†æ˜¯å¦å›æ”¶è¿›åº“å­˜ã€‚
    - ğŸ§­ **å¯¼èˆªè®¾ç½®**: å¯é€‰æ‹©åŠ å…¥ LDC å¯¼èˆªï¼Œå¹¶æ§åˆ¶å‰å°å¯¼èˆªå…¥å£æ˜¾ç¤ºã€‚
    - ğŸ¨ **ä¸»é¢˜è‰²ä¸é¡µè„š**: æ”¯æŒä¸»é¢˜è‰²é€‰æ‹©ä¸è‡ªå®šä¹‰é¡µè„šæ–‡æ¡ˆã€‚
    - ğŸ”” **æ›´æ–°æ£€æŸ¥**: ç®¡ç†åå°è‡ªåŠ¨æ£€æµ‹æ–°ç‰ˆæœ¬å¹¶æç¤ºã€‚
- **ç§¯åˆ†ç³»ç»Ÿ**:
    - âœ¨ **æ¯æ—¥ç­¾åˆ°**: ç”¨æˆ·æ¯æ—¥ç­¾åˆ°é¢†å–ç§¯åˆ†ã€‚
    - ğŸ’° **ç§¯åˆ†æŠµæ‰£**: è´­ä¹°å•†å“æ—¶å¯ä½¿ç”¨ç§¯åˆ†æŠµæ‰£é‡‘é¢ã€‚
    - ğŸ **ç§¯åˆ†æ”¯ä»˜**: è‹¥ç§¯åˆ†è¶³å¤Ÿæ”¯ä»˜å…¨æ¬¾ï¼Œæ— éœ€è·³è½¬æ”¯ä»˜å¹³å°ç›´æ¥æˆäº¤ã€‚
- **å¤šè¯­è¨€ä¸ä¸»é¢˜**:
    - ğŸŒ **ä¸­è‹±åˆ‡æ¢**ã€‚
    - ğŸŒ“ **æµ…è‰²/æ·±è‰²/è·Ÿéšç³»ç»Ÿ**ã€‚
    - â±ï¸ **è‡ªåŠ¨æ›´æ–°**: æ”¯æŒ GitHub Actions è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸ä»£ç ã€‚
- **é€šçŸ¥ç³»ç»Ÿ**:
    - ğŸ“§ **å‘è´§é‚®ä»¶**: æ”¯æŒ Resend å‘é€è®¢å•å‘è´§é€šçŸ¥é‚®ä»¶ã€‚
    - ğŸ“¢ **Telegram é€šçŸ¥**: æ”¯æŒæ–°è®¢å• Telegram Bot æ¶ˆæ¯æ¨é€ã€‚
    - ğŸ“® **ç«™å†…æ”¶ä»¶ç®±**: ç”¨æˆ·å¯åœ¨ä¸ªäººä¸­å¿ƒæŸ¥çœ‹å‘è´§/é€€æ¬¾/ç®¡ç†å‘˜æ¶ˆæ¯é€šçŸ¥ï¼Œå¹¶æ˜¾ç¤ºæœªè¯»æç¤ºã€‚
    - ğŸ’¬ **è”ç³»ç®¡ç†å‘˜**: ç”¨æˆ·å¯å‘ç®¡ç†å‘˜å‘èµ·ç«™å†…æ¶ˆæ¯ã€‚
    - ğŸŒ **LDC å¯¼èˆª**: ç«™ç‚¹å¯è‡ªæ„¿åŠ å…¥å¯¼èˆªé¡µï¼Œå±•ç¤ºå•†åŸä¿¡æ¯ã€‚

## ğŸš€ éƒ¨ç½²æŒ‡å—

### ç½‘é¡µéƒ¨ç½² (Workers Builds)

æ— éœ€å‘½ä»¤è¡Œï¼Œå®Œå…¨åœ¨ Cloudflare Dashboard æ“ä½œã€‚

#### 1. åˆ›å»º D1 æ•°æ®åº“

1. ç™»å½• [Cloudflare Dashboard](https://dash.cloudflare.com)
2. å·¦ä¾§èœå• **Storage & Databases** â†’ **D1**
3. ç‚¹å‡» **Create database**ï¼Œè¾“å…¥åç§°ï¼š**`ldc-shop-next`**

> ğŸ’¡ **æ¨èä½¿ç”¨é»˜è®¤åç§° `ldc-shop-next`**ï¼šé¡¹ç›®çš„ `wrangler.json` å·²é…ç½®è‡ªåŠ¨ç»‘å®šæ­¤åç§°çš„æ•°æ®åº“ï¼Œä½¿ç”¨é»˜è®¤åç§°å¯ä»¥è·³è¿‡æ‰‹åŠ¨ç»‘å®šæ­¥éª¤ã€‚

#### 2. è¿æ¥ Git ä»“åº“éƒ¨ç½²

1. Cloudflare Dashboard â†’ **Workers & Pages** â†’ **Create application**
2. é€‰æ‹© **Connect to Git**ï¼Œè¿æ¥ä½ çš„ GitHub/GitLab ä»“åº“
3. é…ç½®æ„å»ºè®¾ç½®ï¼š
   - **Path**: `_workers_next`
   - **Build command**: `npm install && npx opennextjs-cloudflare build`
   - **Deploy command**: `npx wrangler deploy`

4. ç‚¹å‡» **Deploy**

#### 3. ç»‘å®š D1 æ•°æ®åº“

**å¦‚æœä½ ä½¿ç”¨äº†é»˜è®¤æ•°æ®åº“å `ldc-shop-next`**ï¼Œæ•°æ®åº“ä¼šè‡ªåŠ¨ç»‘å®šï¼Œå¯ä»¥è·³è¿‡æ­¤æ­¥éª¤ã€‚

**å¦‚æœä½ ä½¿ç”¨äº†å…¶ä»–æ•°æ®åº“å**ï¼Œéœ€è¦æ‰‹åŠ¨ç»‘å®šï¼š

1. éƒ¨ç½²åï¼Œè¿›å…¥é¡¹ç›® **Settings** â†’ **Bindings**
2. ç‚¹å‡» **Add binding**
3. é€‰æ‹© **D1 Database**
4. **Variable name**: `DB`ï¼ˆå¿…é¡»æ˜¯è¿™ä¸ªåå­—ï¼‰
5. é€‰æ‹©ä½ åˆ›å»ºçš„æ•°æ®åº“
6. ä¿å­˜

#### 4. é…ç½®ç¯å¢ƒå˜é‡

è¿›å…¥é¡¹ç›® **Settings** â†’ **Variables and Secrets**ï¼š

| å˜é‡å | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `OAUTH_CLIENT_ID` | Secret | Linux DO Connect Client ID |
| `OAUTH_CLIENT_SECRET` | Secret | Linux DO Connect Client Secret |
| `MERCHANT_ID` | Secret | EPay å•†æˆ· ID |
| `MERCHANT_KEY` | Secret | EPay å•†æˆ· Key |
| `AUTH_SECRET` | Secret | éšæœºå­—ç¬¦ä¸² (å¯ç”¨ `openssl rand -base64 32` ç”Ÿæˆ) |
| `ADMIN_USERS` | Secret | ç®¡ç†å‘˜ç”¨æˆ·åï¼Œé€—å·åˆ†éš” |
| `NEXT_PUBLIC_APP_URL` | **Text** | ä½ çš„ Workers åŸŸå (å¦‚ `https://ldc-shop.xxx.workers.dev`) |

> âš ï¸ **é‡è¦**: `NEXT_PUBLIC_APP_URL` **å¿…é¡»**è®¾ç½®ä¸º Text ç±»å‹ï¼Œä¸èƒ½ç”¨ Secretï¼Œå¦åˆ™æ”¯ä»˜ç­¾åä¼šå¤±è´¥ï¼

**å›è°ƒåœ°å€é…ç½®ï¼š**

å‡è®¾ä½ çš„ Workers åŸŸåæ˜¯ `https://ldc-shop.xxx.workers.dev`ï¼š

| å¹³å° | é…ç½®é¡¹ | åœ°å€ |
|------|--------|------|
| Linux DO Connect | å›è°ƒåœ°å€ (Callback URL) | `https://ldc-shop.xxx.workers.dev/api/auth/callback/linuxdo` |
| EPay / Linux DO Credit | é€šçŸ¥ URL (Notify URL) | `https://ldc-shop.xxx.workers.dev/api/notify` |
| EPay / Linux DO Credit | å›è°ƒ URL (Return URL) | `https://ldc-shop.xxx.workers.dev/callback` |

#### 5. é¦–æ¬¡è®¿é—®

è®¿é—®ä½ çš„ Workers åŸŸåï¼Œé¦–é¡µä¼šè‡ªåŠ¨åˆ›å»ºæ‰€æœ‰æ•°æ®åº“è¡¨ã€‚

---

## ğŸ’» æœ¬åœ°å¼€å‘

æœ¬åœ°å¼€å‘ä½¿ç”¨ SQLite æ–‡ä»¶æ¨¡æ‹Ÿ D1ã€‚

1. **é…ç½®æœ¬åœ°ç¯å¢ƒ**
   å¤åˆ¶ `.env.example` (å¦‚æœæœ‰) æˆ–ç›´æ¥åˆ›å»º `.env.local`ï¼š
   ```bash
   LOCAL_DB_PATH=local.sqlite
   ```

2. **ç”Ÿæˆæœ¬åœ°æ•°æ®åº“**
   ```bash
   npx drizzle-kit push
   ```
   è¿™ä¼šåˆ›å»ºä¸€ä¸ª `local.sqlite` æ–‡ä»¶ã€‚

3. **å¯åŠ¨å¼€å‘æœåŠ¡å™¨**
   ```bash
   npm run dev
   ```
   è®¿é—® `http://localhost:3000`ã€‚

## âš™ï¸ ç¯å¢ƒå˜é‡è¯´æ˜

| å˜é‡å | è¯´æ˜ |
|---|---|
| `OAUTH_CLIENT_ID` | Linux DO Connect Client IDï¼ˆå»ºè®® Secretï¼‰ |
| `OAUTH_CLIENT_SECRET` | Linux DO Connect Client Secretï¼ˆSecretï¼‰ |
| `MERCHANT_ID` | EPay å•†æˆ· IDï¼ˆå»ºè®® Secretï¼‰ |
| `MERCHANT_KEY` | EPay å•†æˆ· Keyï¼ˆSecretï¼‰ |
| `AUTH_SECRET` | NextAuth åŠ å¯†å¯†é’¥ï¼ˆSecretï¼‰ |
| `ADMIN_USERS` | ç®¡ç†å‘˜ç”¨æˆ·ååˆ—è¡¨ (é€—å·åˆ†éš”ï¼Œå»ºè®® Secret) |
| `NEXT_PUBLIC_APP_URL` | éƒ¨ç½²åçš„å®Œæ•´ URL (ç”¨äºå›è°ƒï¼Œå¿…é¡» Text) |

## ğŸ“„ è®¸å¯è¯
MIT
